<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database</title>
    <link rel="stylesheet" href="../../../css/style.css">
</head>

<body>

<section class="container">
    <h1 class="no_mb"><a href="../">Database</a></h1>
    <div class="after-h1">Вопросы и ответы для подготовки к собеседованиям</div>
    <div class="breadcrumbs">
        <p><a href="../../../">главная</a></p>
        <p><a href="../">Questions</a></p>
        <p>Database</p>
    </div>
    <ul class="menu">
        <li><a href="#transaction">Transaction</a></li>
        <li><a href="#">Index DB</a></li>
    </ul>
</section>

<section class="container" id="transaction">
    <h1><a href="#">Транзакции</a></h1>
    <ul class="menu after-h1">
        <li><a href="#acid">ACID</a></li>
        <li><a href="#isolation_levels">Уровни изоляций в SQL</a></li>
        <li><a href="#anomalies">Аномалии</a></li>
        <li><a href="#propagation">Распространение транзакций</a></li>
        <li><a href="#problem">Грабли @Transactional</a></li>
    </ul>

    <div id="intro">
        <p class="term">
            <span>Транзакция</span>
            - группа последовательных операций с базой данных, которая представляет собой
            логическую единицу работы с данными.
        </p>
        <p>
            Транзакция может быть выполнена либо целиком и успешно, соблюдая целостность данных и
            независимо от параллельно идущих других транзакций, либо не выполнена вообще,
            и тогда она не должна произвести никакого эффекта.
        </p>
    </div>

    <hr>
    <div id="acid">
        <h3 class="no_mb"><a href="#transaction">ACID</a></h3>
        <p class="term">
            (от англ. atomicity, consistency, isolation, durability)
            - набор требований к транзакционной системе, обеспечивающий наиболее надёжную и предсказуемую её работу.
        </p>
        <p>Свойства ACID:</p>
        <ul class="margined">
            <li>
                <p class="term">
                    <span>Атомарность (Atomicity)</span><br>
                    Гарантирует, что никакая транзакция не будет зафиксирована в системе частично.
                    Будут либо выполнены все её подоперации, либо не выполнено ни одной.
                </p>
            </li>
            <li>
                <p class="term">
                    <span>Согласованность (Consistency)</span><br>
                    Транзакция, достигающая своего нормального завершения и тем самым фиксирующая свои результаты,
                    сохраняет согласованность базы данных.
                </p>
            </li>
            <li>
                <p class="term">
                    <span>Изоляция (Isolation)</span><br>
                    Во время выполнения транзакции параллельные транзакции не должны оказывать влияния на её результат.
                </p>
            </li>
            <li>
                <p class="term">
                    <span>Устойчивость (Durability)</span><br>
                    Независимо от проблем на нижних уровнях (к примеру, обесточивание системы или сбои в оборудовании)
                    изменения, сделанные успешно завершённой транзакцией,
                    должны остаться сохранёнными после возвращения системы в работу
                </p>
            </li>
        </ul>
        <p>
            <a class="link-to-source" href="https://alexakama.github.io/whitebook/content/courses/sql_course/#acid"
               target="_blank">в ключе SQL</a>
        </p>
        <p class="main-mind">
            Этот набор требований считается фактическим стандартом для высоконадёжных систем,
            прежде всего реляционных СУБД.
        </p>
        <a class="button button--to_content_menu" href="#transaction"></a>
    </div>

    <hr>
    <div id="isolation_levels">
        <h3><a href="#transaction">Уровни изоляции в SQL</a></h3>
        <p>Стандарт SQL-92 определяет четыре уровня изоляции транзакций:</p>
        <ul class="margined">
            <li>
                <p class="term">
                    <span>Read uncommitted</span> (чтение незафиксированных данных).<br>
                    На этом уровне возможно считывание не только логически несогласованных данных,
                    но и данных, изменения которых ещё не зафиксированы.
                </p>
            </li>
            <li>
                <p class="term">
                    <span>Read committed </span>(чтение фиксированных данных).<br>
                    На этом уровне обеспечивается защита от чернового, «грязного» чтения, тем не менее в процессе работы
                    одной транзакции другая может быть успешно завершена и сделанные ею изменения зафиксированы.
                </p>
            </li>
            <li>
                <p class="term">
                    <span>Repeatable read</span> (повторяющееся чтение).<br>
                    На этом уровне не допускается чтение «грязных» (незафиксированных) данных и неповторяющееся чтение.
                </p>
            </li>
            <li>
                <p class="term">
                    <span>Serializable</span> (упорядочиваемость)<br>
                    Самый высокий уровень изолированности (и самый дорогой).
                    Транзакции полностью изолируются друг от друга.
                    Результат выполнения нескольких параллельных транзакций должен быть таким,
                    как если бы они выполнялись последовательно.
                </p>
            </li>
        </ul>
        <p>Конкретный уровень изоляции обеспечивает сама СУБД с помощью своих внутренних механизмов.</p>
        <p>
            Например Postgres поддерживает только последние 3ри, а oracle и того меньше - Read committed и Serializable.
        </p>
        <a class="button button--to_content_menu" href="#transaction"></a>
    </div>

    <hr>
    <div id="anomalies">
        <h3><a href="#transaction">Аномалии</a></h3>
        <p>
            Если уровень транзакции установлен неверно,
            при чтении данных из базы данных могут возникнуть следующие аномалии:
        </p>
        <ul class="margined">
            <li>
                <p class="term">
                    <span>Потерянное обновление</span><br>
                    Две транзакции читают одну и ту же строку таблицы, затем одна из них обновляет эту строку,
                    после чего вторая обновляет эту же строку, не учитывая изменений, сделанных первой транзакцией.
                </p>
            </li>
            <li>
                <p class="term">
                    <span>Грязное чтение</span><br>
                    Транзакция читает ещё не зафиксированные изменения, сделанные другой транзакцией.
                </p>
            </li>
            <li>
                <p class="term">
                    <span>Неповторяющееся чтение</span><br>
                    Транзакция читает одну и ту же строку два раза, а в промежутке между чтениями вторая транзакция
                    изменяет (или удаляет) эту строку и фиксирует изменения.
                    Тогда первая транзакция получит разные результаты.
                </p>
            </li>
            <li>
                <p class="term">
                    <span>Фантомное чтение</span><br>
                    Одна транзакция два раза читает набор строк по одинаковому условию, а в промежутке между чтениями
                    другая транзакция добавляет строки, удовлетворяющие этому условию, и фиксирует изменения. Тогда
                    первая транзакция получит разные наборы строк.
                </p>
            </li>
        </ul>
        <a class="button button--to_content_menu" href="#transaction"></a>
    </div>

    <hr>
    <div id="propagation">
        <h3><a href="#transaction">Распространение транзакций</a></h3>
        <p>Распространение транзакций (Propagation) в @Transactional</p>
        <ul class="margined">
            <li>
                <p class="term">
                    <span>REQUIRED(0)</span><br>
                    Если активная транзакция уже существует, метод будет выполняться в её контексте.
                    Если транзакции нет, она будет создана. Режим по-умолчанию.
                </p>
            </li>
            <li>
                <p class="term">
                    <span>SUPPORTS(1)</span><br>
                    Если существует активная транзакция, метод будет выполнен в её контексте.
                    Если транзакции нет, метод будет выполнен вне контекста транзакции.
                </p>
            </li>
            <li>
                <p class="term">
                    <span>MANDATORY(2)</span><br>
                    Метод требует наличия активной транзакции. Если ее нет, будет выброшено
                    <span class="bad">исключение</span>.
                </p>
            </li>
            <li>
                <p class="term">
                    <span>REQUIRES_NEW(3)</span><br>
                    Метод всегда будет выполняться в новой транзакции.
                    Если уже есть активная транзакция, она будет приостановлена до завершения новой транзакции.
                </p>
            </li>
            <li>
                <p class="term">
                    <span>NOT_SUPPORTED(4)</span><br>
                    Метод будет выполняться вне контекста транзакции.
                    Если имеется активная транзакция, она будет приостановлена на время его выполнения.
                </p>
            </li>
            <li>
                <p class="term">
                    <span>NEVER(5)</span><br>
                    Метод никогда не должен быть выполнен в контексте транзакции.
                    Если транзакция активна, будет выброшено <span class="bad">исключение</span>.
                </p>
            </li>
            <li>
                <p class="term">
                    <span>NESTED(6)</span><br>
                    Метод будет выполнен в рамках вложенной транзакции, если уже существует активная транзакция.
                    В противном случае, будет создана новая транзакция.
                </p>
                <p class="example">
                    Вложенные транзакции позволяют откатывать только часть операции без влияния на внешнюю транзакцию.
                    Однако поддержка этой модели зависимости от конкретных систем управления транзакциями может
                    отличаться.
                </p>
            </li>
        </ul>
        <p>
            <a class="link-to-source" href="https://youtu.be/ZVYzVqqVrms" target="_blank">
                интересный видосик про транзакции </a>
        </p>
        <a class="button button--to_content_menu" href="#transaction"></a>
    </div>

    <hr>
    <div id="problem">
        <h3><a href="#transaction">Грабли в JAVA</a></h3>
        <p>
            Грабли при использовании аннотации @Transactional:
        </p>
        <ul class="margined">
            <li>Не вызывать метод, помеченный @Transactional из одного класса.</li>
            <li>
                <p>
                    @Transactional не откатит транзакцию если выброшено Exception, работает с RuntimeException.
                </p>
                <div class="example">
                    <p>Но можно настроить</p>
                    <div class="code" style="padding: 5px">@Transactional(rollbackFor=Exception.class)</div>
                </div>
            </li>
            <li>@Transactional работает только с public методами.</li>
            <li>@Transactional занимает соединение с БД.</li>
        </ul>
        <p>
            <a class="link-to-source" href="https://youtu.be/2E8FKi4oC0o" target="_blank">
                очень кратенько, но полезненько</a>
        </p>
        <a class="button button--to_content_menu" href="#transaction"></a>
    </div>

</section>

<a href="#" class="button button--top"></a>

<footer>
    <div class="footer__text"><a href="https://t.me/java40plus" title="Мой блог в телеграм" target="_blank">
        Ⓒ Алексей Маслов, 2021-2024
    </a></div>
</footer>

</body>

</html>